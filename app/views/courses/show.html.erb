<%= render 'shared/header' %>

<div class="row">
  <div class="small-12 columns text-center info-text">
    Monte a sua grade
    <div class="subtext"><%= @course.name %></div>
  </div>

</div>

<div class="row">
  <ul id="blockTabs" class="tabs" data-tabs>
    <li class="tabs-title is-active" aria-selected="true"><a href="#mandatory">Obrigatórias</a></li>
    <li class="tabs-title"><a href="#elective">Optativas</a></li>
    <li class="tabs-title"><a href="#offered">Ofertadas</a></li>
    <li class="tabs-title"><a href="#all">Todas</a></li>
  </ul>
</div>

<div class="row block tabs-content" data-tabs-content="blockTabs">
  <div id="mandatory" class="tabs-panel no-padding is-active">
    <div class="row show-for-large">
      <div class="medium-1 columns text-center no-padding column-title">
        Semestre
      </div>
      <div class="medium-11 columns text-center column-title">
        Disciplinas
      </div>
    </div>

    <% unless @semesters.blank? %>
      <% width = 100.0 / @semesters.max_by{ |s| s ? s.size : 0 }.size %>
      <% @semesters[1..-1].each_with_index do |semester, i| %>
        <% if semester %>
          <div class="row semester-row">
            <div class="small-12 large-1 columns text-center no-padding semester">
              <span class="number"><%= i + 1 %><span class="hide-for-large">º Semestre</span></span>
            </div>

            <div class="small-12 large-11 columns">
              <% semester.each do |discipline| %>
                <div id="<%= discipline.code %>" code="<%= discipline.code %>" class="block-discipline discipline text-center" style="width: <%= width %>%;">
                  <div class="text">
                    <div class="code"><%= discipline.code %></div>
                    <div class="name"><%= discipline.name %></div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>

  <div id="elective" class="tabs-panel no-padding">
    <div class="search">
      <i class="icon-search"></i>
      <input id="electiveFilterInput" class="search-bar small-12 large-offset-1 large-10 columns" type="text" placeholder="Nome ou código da disciplina" />
    </div>

    <div class="small-12 columns no-padding">
      <ul class="block-list">
        <% @ops.each do |op| %>
          <li code="<%= op.code %>" class="block-list-item list-item-discipline elective-discipline discipline"><%= "#{op.code} - #{op.name}" %></li>
        <% end %>
      </ul>
    </div>
  </div>

  <div id="offered" class="tabs-panel no-padding">
    <div class="search">
      <i class="icon-search"></i>
      <input id="offeredFilterInput" class="search-bar small-12 large-offset-1 large-10 columns" type="text" placeholder="Nome ou código da disciplina" />
    </div>

    <div class="small-12 columns no-padding">
      <ul class="block-list">
        <% @offered.each do |offered| %>
          <li code="<%= offered.code %>" class="block-list-item list-item-discipline offered-discipline discipline"><%= "#{offered.code} - #{offered.name}" %></li>
        <% end %>
      </ul>
    </div>
  </div>

  <div id="all" class="tabs-panel no-padding row">
    <div class="search small-12 medium-10 columns">
      <i class="icon-search"></i>
      <input id="allinput" class="search-bar small-12 large-offset-1 large-10 columns" type="text" placeholder="Nome ou código da disciplina" />
    </div>
    <div class="small-12 medium-2 columns">
      <button id="buttonS" type="submit" class="button expanded">Buscar</button>
    </div>

    <div class="small-12 columns">
      <ul id="allBlockList" class="block-list">
      </ul>
    </div>
  </div>
</div>

<div id="disciplineModal" class="large reveal" data-reveal>

  <div id="loader"></div>

  <div id="modalWrapper" class="row">
    <div id="content" class="small-12 large-6 columns discipline-info"></div>

    <div class="small-12 large-6 columns table-wrapper">
      <div class="title">Grade de Horários</div>
      <%= render partial: 'schedule_table' %>
    </div>
  </div>

  <button class="close-button" data-close aria-label="Close reveal" type="button">
    <span aria-hidden="true">&times;</span>
  </button>
</div>

<% content_for :script do %>
<script>
  var preRequisites       = <%= raw @pre  %>;
  var postRequisites      = <%= raw @post %>;

  var changeBgColor = function(code, colorPre, colorPost) {
    return function() {
      if (preRequisites[code]) {
        preRequisites[code].forEach(function(preReq) {
          var $preReq = $("#" + preReq);
          if ($preReq)
            $preReq.css("background-color", colorPre);
        });
      }

      if (postRequisites[code]) {
        postRequisites[code].forEach(function(postReq) {
          var $postReq = $("#" + postReq);
          if ($postReq)
            $postReq.css("background-color", colorPost);
        });
      }
    };
  }

  var updateDisciplineEvents = function(class_name) {
    $("." + class_name).click(function(event) {
      $.ajax({
        type: 'GET',
        url: '<%= discipline_get_information_path %>',
        data: { code: $(this).attr('code'), course: <%= params[:code] %> },
        dataType: 'html',
        beforeSend: function() {
          $("#content").empty();
          $("#modalWrapper").hide();
          $("#loader").show();
          if (class_name != "modal-discipline")
            $("#disciplineModal").foundation('open');
        }
      })
      .done(function(html) {
        $("#loader").hide();
        $("#modalWrapper").show();
        $("#content").html(html);
        $("#content").foundation();
        updateDisciplineEvents("modal-discipline");
      });
      event.stopPropagation();
      event.preventDefault();
    });
  }

  $("#electiveFilterInput").on("input", function() {
    filterList("elective-discipline", $(this).val());
  });

  $("#offeredFilterInput").on("input", function() {
    filterList("offered-discipline", $(this).val());
  });

  $("#buttonS").click(function() {
    var pattern = $("#allinput").val();
    if (pattern.length == 0)
      $("#allinput").addClass("error");
    else {
      $("#allinput").removeClass("error");
      $("#allBlockList").empty();

      $.ajax({
        type: 'GET',
        url: '<%= discipline_ajax_search_path %>',
        data: { pattern: $("#allinput").val() },
        dataType: 'html'
      })
      .done(function(html) {
        $("#allBlockList").html(html);
        updateDisciplineEvents("search-discipline");
      });
    }
  });

  $(document).ready(function() {
    // Start loading spinner
    var spinner = new Spinner().spin();
    $("#loader").append(spinner.el)

    // Add hover event effects to pre and post requisites
    $(".block-discipline").each(function() {
      var code = $(this).attr("code");

      $(this).mouseenter(changeBgColor(code, "#F5C5C5", "#C5F5C5"));
      $(this).mouseleave(changeBgColor(code, "", ""));
    });

    // Add click event to get discipline informations
    updateDisciplineEvents("discipline");
  });
</script>
<% end %>